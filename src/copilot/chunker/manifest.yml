# The manifest for the "chunker" service.
# Read the full specification for the "Backend Service" type at:
#  https://aws.github.io/copilot-cli/docs/manifest/backend-service/

# Your service name will be used in naming your resources like log groups, ECS services, etc.
name: chunker
type: Backend Service

# Your service does not allow any traffic.

# Configuration for your containers and service.
image:
  # Docker build arguments.
  build:
    context: .
    dockerfile: data/Dockerfile

cpu: 1024 # Number of CPU units for the task.
memory: 8192 # Amount of memory in MiB used by the task.
platform: linux/x86_64 # See https://aws.github.io/copilot-cli/docs/manifest/backend-service/#platform
count: 4 # Number of tasks that should be running in your service.
exec: true # Enable running commands in your container.

# storage:
# readonly_fs: true       # Limit to read-only access to mounted root filesystems.

# Optional fields for more advanced use-cases.
#
# Pass environment variables as key value pairs.

storage:
  ephemeral: 80

variables:
  TOPIC_IN: video_uploads
  S3_INPUT_DIR: raw-videos-02
  S3_OUTPUT_DIR: processed-videos-visionai
  GROUP_ID: video_processors
  BOOTSTRAP_SERVERS: boot-38rpf9kk.c1.kafka-serverless.ca-central-1.amazonaws.com:9098
  TOPIC_OUT: chunked_vids

# taskrole:
#   statements:
#     - effect: Allow
#       actions:
#         - kafka-cluster:Connect
#         - kafka-cluster:DescribeCluster
#         - kafka-cluster:DescribeTopic
#         - kafka-cluster:ReadData
#         - kafka-cluster:DescribeGroup
#         - kafka-cluster:AlterGroup
#         - ssm:GetParameter
#         - ssm:GetParameters
#       resources:
#         - arn:aws:kafka:ca-central-1:730335337132:cluster/visionai-kafka/a0da412d-2485-482f-a653-687e43ff5db0-s1
#         - arn:aws:kafka:ca-central-1:730335337132:topic/visionai-kafka/a0da412d-2485-482f-a653-687e43ff5db0-s1/video_uploads
#         - arn:aws:kafka:ca-central-1:730335337132:group/visionai-kafka/a0da412d-2485-482f-a653-687e43ff5db0-s1/video_processors
#         - arn:aws:ssm:ca-central-1:730335337132:parameter/copilot/visionai/test/secrets/BOOTSTRAP_SERVERS

# secrets:                      # Pass secrets from AWS Systems Manager (SSM) Parameter Store.
#   BOOTSTRAP_SERVERS: /copilot/visionai/test/secrets/BOOTSTRAP_SERVERS  # The key is the name of the environment variable, the value is the name of the SSM parameter.

# You can override any of the values defined above by environment.
environments:
  test:
    network:
      vpc:
        placement: "private" # The tasks will be placed on private subnets for the "test" environment.
# task:
#   # … your existing settings …
#   command: ["sleep", "3600"]
#   test:
#     count: 2                # Number of tasks to run for the "test" environment.
#     deployment:           # The deployment strategy for the "test" environment.
#         rolling: 'recreate' # Stops existing tasks before new ones are started for faster deployments.
